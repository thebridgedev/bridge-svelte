name: "Sync Docs to GitLab (Bridge Web)"
description: "Syncs /learning folder to bridge-web GitLab repo using a sync-docs branch."
runs:
  using: "composite"

  steps:
    - name: ðŸ§¾ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ” Setup SSH for GitLab
      shell: bash
      run: |
        set -e
        
        # Create SSH directory with proper permissions
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Debug: Check if the secret is set
        if [ -z "$DOCS_SYNC_SSH_KEY" ]; then
          echo "âŒ DOCS_SYNC_SSH_KEY secret is not set"
          exit 1
        fi
        
        # Write SSH key with proper formatting and validation
        echo "ðŸ” Writing SSH key..."
        echo "$DOCS_SYNC_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Validate SSH key format
        echo "ðŸ” Validating SSH key format..."
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "âŒ Invalid SSH key format detected"
          echo "ðŸ” First few characters of key:"
          head -c 50 ~/.ssh/id_rsa
          echo ""
          echo "ðŸ” Last few characters of key:"
          tail -c 50 ~/.ssh/id_rsa
          exit 1
        fi
        
        # Add GitLab to known hosts
        echo "ðŸ” Adding GitLab to known hosts..."
        ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        
        # Try SSH agent approach first
        echo "ðŸ” Starting SSH agent..."
        eval "$(ssh-agent -s)"
        
        echo "ðŸ” Adding SSH key to agent..."
        if ssh-add ~/.ssh/id_rsa; then
          echo "âœ… SSH key added to agent successfully"
        else
          echo "âš ï¸ Failed to add SSH key to agent, trying direct key approach..."
          # Set SSH config to use the key directly
          cat > ~/.ssh/config << EOF
Host gitlab.com
    HostName gitlab.com
    User git
    IdentityFile ~/.ssh/id_rsa
    IdentitiesOnly yes
    StrictHostKeyChecking no
EOF
          chmod 600 ~/.ssh/config
        fi
        
        # Test SSH connection
        echo "ðŸ” Testing SSH connection to GitLab..."
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -T git@gitlab.com || echo "âš ï¸ SSH test completed (expected for GitLab)"
        
        echo "âœ… SSH setup completed"

    - name: ðŸ§  Sync /learning folder to Bridge Web (sync-docs branch)
      shell: bash
      run: |
        set -e

        REPO_NAME=$(basename "${{ github.repository }}")
        GITLAB_REPO="git@gitlab.com:nebulrgroup/bridge/bridge-web.git"
        SYNC_BRANCH="sync-docs/$REPO_NAME"

        echo "ðŸ”„ Syncing /learning content from $REPO_NAME â†’ $GITLAB_REPO ($SYNC_BRANCH)"
        
        # Verify SSH key is loaded
        echo "ðŸ” Verifying SSH key is loaded..."
        ssh-add -l || echo "âš ï¸ No SSH keys loaded in agent"
        
        # Test GitLab connectivity before cloning
        echo "ðŸ” Testing GitLab connectivity..."
        ssh -o ConnectTimeout=10 -T git@gitlab.com || echo "âš ï¸ SSH test completed (expected for GitLab)"

        echo "ðŸ“¥ Cloning repository..."
        git clone "$GITLAB_REPO"
        cd bridge-web

        git config user.name "Docs Sync Bot"
        git config user.email "docs.bot@nebulr.dev"

        TARGET_PATH="bridge-docs/synced/$REPO_NAME"
        mkdir -p "$TARGET_PATH"

        # Remove old synced content for this plugin
        rm -rf "$TARGET_PATH"/* || true

        # Copy new content
        cp -r ../learning/* "$TARGET_PATH"/ || true
        if [ -f ../README.md ]; then cp ../README.md "$TARGET_PATH/index.md"; fi

        git add .

        if git diff --cached --quiet; then
          echo "âœ… No new documentation changes to sync."
          exit 0
        fi

        git commit -m "Sync learning docs from $REPO_NAME@${{ github.sha }}" || true

        echo "ðŸ§© Preparing sync branch $SYNC_BRANCH..."
        git fetch origin $SYNC_BRANCH || true
        git checkout -B $SYNC_BRANCH

        echo "âš™ï¸ Rebasing on latest origin/$SYNC_BRANCH (if exists)..."
        if git show-ref --quiet refs/remotes/origin/$SYNC_BRANCH; then
          if ! git rebase origin/$SYNC_BRANCH; then
            echo "âš ï¸ Rebase conflict detected â€” aborting and retrying with merge strategy."
            git rebase --abort || true
            git pull --rebase=false --strategy-option ours origin $SYNC_BRANCH || true
          fi
        fi

        echo "ðŸš€ Pushing updates to GitLab branch $SYNC_BRANCH..."
        if ! git push origin HEAD:$SYNC_BRANCH; then
          echo "âš ï¸ Initial push failed â€” pulling latest and retrying once."
          git pull --rebase=false origin $SYNC_BRANCH || true
          git push origin HEAD:$SYNC_BRANCH || echo "âŒ Push still failed, manual review needed."
        fi

        echo "âœ… Sync complete for $REPO_NAME â†’ $GITLAB_REPO@$SYNC_BRANCH"

