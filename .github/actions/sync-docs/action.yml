name: "Sync Docs to GitLab (Bridge Web)"
description: "Syncs /learning folder to bridge-web GitLab repo using a sync-docs branch."
runs:
  using: "composite"

  steps:
    - name: üßæ Checkout repository
      uses: actions/checkout@v4

    - name: üîê Setup SSH for GitLab
      shell: bash
      run: |
        set -e
        
        # Create SSH directory with proper permissions
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Debug: Check if the secret is set
        if [ -z "$DOCS_SYNC_KEY" ]; then
          echo "‚ùå DOCS_SYNC_KEY secret is not set"
          exit 1
        fi
        
        # Write SSH key with proper formatting and validation
        echo "üîç Writing SSH key..."
        echo "$DOCS_SYNC_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Validate SSH key format
        echo "üîç Validating SSH key format..."
        if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
          echo "‚ùå Invalid SSH key format detected"
          echo "üîç First few characters of key:"
          head -c 50 ~/.ssh/id_rsa
          echo ""
          echo "üîç Last few characters of key:"
          tail -c 50 ~/.ssh/id_rsa
          exit 1
        fi
        
        # Add GitLab to known hosts
        echo "üîç Adding GitLab to known hosts..."
        ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        
        # Try SSH agent approach first
        echo "üîç Starting SSH agent..."
        eval "$(ssh-agent -s)"
        
        echo "üîç Adding SSH key to agent..."
        if ssh-add ~/.ssh/id_rsa; then
          echo "‚úÖ SSH key added to agent successfully"
        else
          echo "‚ö†Ô∏è Failed to add SSH key to agent, trying direct key approach..."
          # Set SSH config to use the key directly
          echo "Host gitlab.com" > ~/.ssh/config
          echo "    HostName gitlab.com" >> ~/.ssh/config
          echo "    User git" >> ~/.ssh/config
          echo "    IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "    IdentitiesOnly yes" >> ~/.ssh/config
          echo "    StrictHostKeyChecking no" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
        fi
        
        # Test SSH connection
        echo "üîç Testing SSH connection to GitLab..."
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -T git@gitlab.com || echo "‚ö†Ô∏è SSH test completed (expected for GitLab)"
        
        echo "‚úÖ SSH setup completed"

    - name: üß† Sync /learning folder to Bridge Web (sync-docs branch)
      shell: bash
      run: |
        set -e

        REPO_NAME=$(basename "${{ github.repository }}")
        GITLAB_REPO="git@gitlab.com:nebulrgroup/bridge/bridge-web.git"
        SYNC_BRANCH="sync-docs/$REPO_NAME"

        echo "üîÑ Syncing /learning content from $REPO_NAME ‚Üí $GITLAB_REPO ($SYNC_BRANCH)"
        
        # Verify SSH key is loaded
        echo "üîç Verifying SSH key is loaded..."
        ssh-add -l || echo "‚ö†Ô∏è No SSH keys loaded in agent"
        
        # Test GitLab connectivity before cloning
        echo "üîç Testing GitLab connectivity..."
        ssh -o ConnectTimeout=10 -T git@gitlab.com || echo "‚ö†Ô∏è SSH test completed (expected for GitLab)"

        echo "üì• Cloning repository..."
        git clone "$GITLAB_REPO"
        cd bridge-web

        git config user.name "Docs Sync Bot"
        git config user.email "docs.bot@nebulr.dev"

        TARGET_PATH="bridge-docs/synced/$REPO_NAME"
        mkdir -p "$TARGET_PATH"

        # Remove old synced content for this plugin
        rm -rf "$TARGET_PATH"/* || true

        # Copy new content
        cp -r ../learning/* "$TARGET_PATH"/ || true
        if [ -f ../README.md ]; then cp ../README.md "$TARGET_PATH/index.md"; fi

        git add .

        if git diff --cached --quiet; then
          echo "‚úÖ No new documentation changes to sync."
          exit 0
        fi

        git commit -m "Sync learning docs from $REPO_NAME@${{ github.sha }}" || true

        echo "üß© Preparing sync branch $SYNC_BRANCH..."
        git fetch origin $SYNC_BRANCH || true
        git checkout -B $SYNC_BRANCH

        echo "‚öôÔ∏è Rebasing on latest origin/$SYNC_BRANCH (if exists)..."
        if git show-ref --quiet refs/remotes/origin/$SYNC_BRANCH; then
          if ! git rebase origin/$SYNC_BRANCH; then
            echo "‚ö†Ô∏è Rebase conflict detected ‚Äî aborting and retrying with merge strategy."
            git rebase --abort || true
            git pull --rebase=false --strategy-option ours origin $SYNC_BRANCH || true
          fi
        fi

        echo "üöÄ Pushing updates to GitLab branch $SYNC_BRANCH..."
        if ! git push origin HEAD:$SYNC_BRANCH; then
          echo "‚ö†Ô∏è Initial push failed ‚Äî pulling latest and retrying once."
          git pull --rebase=false origin $SYNC_BRANCH || true
          git push origin HEAD:$SYNC_BRANCH || echo "‚ùå Push still failed, manual review needed."
        fi

        echo "‚úÖ Sync complete for $REPO_NAME ‚Üí $GITLAB_REPO@$SYNC_BRANCH"

